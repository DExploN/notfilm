<?	namespace controllers;	class paymentsController extends \controller{								public function orderForm($page=1){			if(user()->info('balance')>=config('min_pay') ){				$data['pay']=true;				$pay= new \models\payments();				$data['lastpay']=$pay->lastpaystatus();							}else{				$data['pay']=false;			}			$data['balance']=user()->info('balance');			$data['min_pay']=config('min_pay');			$data['captcha']= \form::getCaptcha(array('width'=>150));									$data['title']='Заказать выплату';			$data['h1']='Заказать выплату';			$data['noindex']='noindex';									$pay = new \models\payments();			$data['list']=$pay->where(array('user_login'=>user()->info('login')))->orderBy(array('timestamp'=>'desc'))->getAllbyPage($page,config('table_list_count'),$num);			$pag=new  \paginator($num,config('table_list_count'),$page);						$data['page']=$pag->build();						$this->finalRender("payments/order",$data);		}				public function order(){			$pay= new \models\payments();			if($pay->order(user()->info('login'),user()->info('balance'),$_POST['text'])){				user()->addlog('Заказал выплату');			}			core()->backpage();		}								public function orderlistForm($page=1){			$pay = new \models\payments();						$data['list']=$pay->where(array('status'=>0))->orderBy(array('timestamp'=>'asc'))->getAllbyPage($page,config('table_list_count'),$num);						$pag=new  \paginator($num,config('table_list_count'),$page);						if($_POST['id'] && $_POST['status']){				$data['pay']=$pay->get($_POST['id']);				$data['pay']['status']=$_POST['status'];				$data['captcha']= \form::getCaptcha(array('width'=>150));				if($_POST['status']==1){						$users = new \models\users();						$user= $users->select('balance')->getByFields(array('login'=>$data['pay']['user_login']));						$data['pay']['maxpay']=$user['balance'];				}			}						$data['page']=$pag->build();						$data['title']='Заявки на выплату';			$data['h1']='Заявки на выплату';			$data['noindex']='noindex';						$this->finalRender("payments/orderlist",$data);		}						public function all_list($page=1){			$pay = new \models\payments();						$data['list']=$pay->orderBy(array('timestamp'=>'desc'))->getAllbyPage($page,config('table_list_count'),$num);						$pag=new  \paginator($num,config('table_list_count'),$page);						$data['page']=$pag->build();						$data['all']=true;						$data['h1']='История выплат';			$data['title']='История выплат';			$data['noindex']='noindex';						$this->finalRender("payments/all_list",$data);		}				public function success(){			$pay= new \models\payments();			$data=$this->filt($_POST,'status','paid','admin_text');						$login=$pay->select('user_login')->get($_POST['id']);			$login=$login['user_login'];						$pay->success($_POST['id'],$data);			switch($data['status']){				case 1:					user()->addlog('Подтвердил выплату '.$login);					break;				case 2:					user()->addlog('Отказал в выплате '.$login);					break;			}						core()->backpage();		}				public function accessRules(){			return array(				'orderForm'=>user()->isAuth(),				'order'=>user()->isAuth(),				'listForm'=>user()->isAuth(),				'success'=>(user()->info('id')==1),				'orderlistForm'=>(user()->info('id')==1),				'all_list'=>(user()->info('id')==1),			);		}		public function captchaRules(){		 return array('order','success');		}	}?>